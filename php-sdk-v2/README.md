# Paypay PHP Client
[![License](https://img.shields.io/:license-apache-orange.svg)](https://opensource.org/licenses/Apache-2.0)
PHP Class for interacting with the Paypay API
This is the quickest way to integrate PayPay payment services. This is primarily meant for merchants who wish to perform interactions with the Paypay API programatically.
With PayPay's OPA SDK, you can build a custom Payment checkout process to suit your unique business needs and branding guidelines.
## Integrating with PayPay OPA
## Prerequisites
Before integrating with the SDK, run through this checklist:
- [*] Understand the payment flow
- [*] Sign up for a PayPay developer/merchant Account
- [*] Generate the API keys from the Developer Panel. Use the sandbox API Keys to test out the integration
## HMAC Signature Verification
Signature verification is a mandatory step to ensure that the callback is sent by PayPay and the payment is received from an authentic source.
### Generate a Signature
The PayPay signature, returned to you by the Checkout form on successful payment, can be regenerated by your system and verified as follows:
Step 1: Hash the body and content-type with MD5 algorithm
Note : If there is no request body, for instance, the HTTP GET method case, no need of generating MD5. Instead hash value is set as "empty".
The value of authHeader is passed in HttpHeader.AUTHORIZATION. With the authHeader will decode back the data added and with the HTTP request object and based on data available for api-key in the system, we will recreate the SHA256("key", requestParams) which gives macData. This macData is verified against the value passed in the header.
### Composer

To install the bindings via [Composer](http://getcomposer.org/), add the following to `composer.json`:

```json
{
  "repositories": [
    {
      "type": "git",
      "url": "https://github.com/GIT_USER_ID/GIT_REPO_ID.git"
    }
  ],
  "require": {
    "GIT_USER_ID/GIT_REPO_ID": "*@dev"
  }
}
```
## Getting Started
You need to setup your key and secret using the following:
``` php
include('PATH_TO_SDK_FOLDER/Client.php');

$client = new Client([
    'API_KEY' => 'YOUR_API_KEY',
    'API_SECRET'=>'YOUR_API_SECRET'
]);

```
## Dynamic QR Code
### Create a dynamic QR Code to receive payments.
``` php
/*
.....initialize SDK
*/
// Set merchant pay identifier
$client->payload->set_merchant_payment_id("YOUR_TRANSACTION_ID");

// Log time of request
$client->payload->set_requested_at();
// Indicate you want QR Code
$client->payload->set_code_type("ORDER_QR");

// Provide order details for invoicing
$order_items = [
    [
        "name" => "Moon Cake",
        "quantity" => 1,
        "category" => "pasteries",
        "productId" => "67678",
        "unitPrice" => [
            "amount" => 1,
            "currency" => "JPY"
        ]
    ]
];
$client->payload->set_order_items($order_items);

// Save Cart totals
$amount = [
    "amount" => 1,
    "currency" => "JPY"
];
$client->payload->set_amount($amount);
// Configure redirects
$client->payload->set_redirect_type('WEB_LINK');
$client->payload->set_redirect_url($_SERVER['SERVER_NAME']);

// Get data for QR code
$response = $client->code->createQRCode();

$data = $response['data'];

```

    For List of params refer to the API guide :
    https://www.paypay.ne.jp/opa/doc/v1.0/dynamicqrcode#operation/createQRCode
### Delete a particular Dynamic QR Code
``` php
/*
.....initialize SDK
*/

$response =  $client->code->deleteQRCode('ID_OF_CODE');
$data = $response['data'];
```
### Fetch a particular QR CODE payment details
``` php
/*
.....initialize SDK
*/

$response =  $client->code->deleteQRCode('ID_OF_CODE');
$data = $response['data'];
```
### Cancel a payment
``` php
/*
.....initialize SDK
*/

$response =  $client->code->cancelPayment('MERCHANT_PAYMENT_ID');
$data = $response['data'];
``` 
### Capture payment details
```php
$client->payload->set_merchant_payment_id("YOUR_TRANSACTION_ID");
$amount = [
    "amount" => 1,
    "currency" => "JPY"
];
$client->payload->set_amount($amount);

$client->payload->set_merchant_capture_id("MERCHANT_CAPTURE_ID")
$client->payload->set_requested_at();
$client->payload->set_order_description("ORDER_DESCRIPTION")
$client->payload->set_code_type("ORDER_QR");
$response = $client->payment->capturePaymentAuth();

$data = $response['data'];

``` 
    For List of params refer to the API guide :
    https://www.paypay.ne.jp/opa/doc/v1.0/dynamicqrcode#operation/capturePaymentAuth
### Revert payment
```php
 $client->payload->set_merchant_revert_id("UNIQUE_REVERT_ID");
 $client->payload->set_payment_id("MERCHANT_PAYMENT_ID");
 $client->payload->set_requested_at();
 $client->payload->set_reason("REASON_FOR_REFUND");
     
 $response = $client->payment->revertAuth($dataOverride = [])
``` 
    For List of params refer to the API guide :
    https://www.paypay.ne.jp/opa/doc/v1.0/dynamicqrcode#operation/revertAuth
### Refund payment
``` php
/*
.....initialize SDK
*/

$client->payload->set_merchant_refund_id('MERCHANT_REFUND_ID');
$client->payload->set_merchant_payment_id('MERCHANT_PAYMENT_ID');
$amount = [
    "amount" => 1,
    "currency" => "JPY"
];
$client->payload->set_amount($amount);
$client->payload->set_requested_at();
$client->payload->set_reason("Refunds test");
$response = $client->refund->refundPayment();
$data = $response['data'];
``` 
    For List of params refer to the API guide :
    https://www.paypay.ne.jp/opa/doc/v1.0/dynamicqrcode#operation/refundPayment
### Fetch refund status and details
``` php
/*
.....initialize SDK
*/
$response=$client->refund->getRefundDetails('UNIQUE_REFUND_ID');
$data = $response['data'];
```
    For List of params refer to the API guide :
    https://www.paypay.ne.jp/opa/doc/v1.0/dynamicqrcode#operation/getRefundDetails
